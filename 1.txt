Sub CalculateEstimate()
'
' CalculateEstimate Макрос
'

'
    Dim allValues As Variant
    Dim tableShift As Long
    Dim estimateName As String
    Dim infoTableStartColumn As Long
    tableShift = 5
    estimateName = getEstimateName()
    allValues = getAllEstimateValues()
    allNMCNames = Array("Стоимость объекта всего, тыс. руб.", "Оборудование", "Материалы", "ФОТ", "БЦ1", "БЦ2", "БЦ3", "БЦ4", "БЦ5", "БЦ6", "БЦ7", "БЦ8", "БЦ9", "БЦ10", "БЦ11", "БЦ12", "БЦ13", "БЦ14", "БЦ15", "БЦ16", "БЦ17", "БЦ18", "БЦ19", "БЦ20", "БЦ21", "БЦ22", "260545", "ЭММ", "в т.ч. оплата механизаторов", "Накладные расходы", "Сметная прибыль", "Время")
    infoTableStartColumn = allValues(UBound(allValues)) + tableShift
    
    Cells(4, infoTableStartColumn).value = "Сумма по расчету"
    Cells(5, infoTableStartColumn).FormulaR1C1 = "=SUM(RC[3]:RC[29],RC[31]:RC[32])"
    Cells(4, infoTableStartColumn + 1).value = "Наименование сметы"
    Cells(5, infoTableStartColumn + 1).value = estimateName
    For i% = 0 To UBound(allNMCNames)
        Cells(4, i + infoTableStartColumn + 2).value = allNMCNames(i)
        Cells(5, i + infoTableStartColumn + 2).value = allValues(i)
    Next i
    range(Cells(5, infoTableStartColumn + 1), Cells(5, infoTableStartColumn + 2 + UBound(allNMCNames))).Copy
End Sub
Function getAllEstimateValues()
    Dim tableWidth As Long
    Dim catalogsSum As Double
    Dim estimateSum As Double

    isCorrectData = False
    tableWidth = ActiveSheet.UsedRange.Column + ActiveSheet.UsedRange.Columns.Count - 1
    columnsInfo = getColumnsWithInformation(tableWidth)
    rowsInfo = getRowsWithInformation(tableWidth)
    cv = getValuesFromOtherCatalogs(columnsInfo(0), columnsInfo(1))
    
    equipment = getValue(rowsInfo(0), columnsInfo(1))
    materials = getValue(rowsInfo(1), columnsInfo(1))
    basicWage = getValue(rowsInfo(2), columnsInfo(1))
    machinesAndMechanisms = getValue(rowsInfo(3), columnsInfo(1))
    machineOperatorsPaiment = getValue(rowsInfo(4), columnsInfo(1))
    overheads = getValue(rowsInfo(5), columnsInfo(1))
    mortalProfit = getValue(rowsInfo(6), columnsInfo(1))
    totalCost = getValue(rowsInfo(7), columnsInfo(1))
    totalTime = getTime(rowsInfo(7), columnsInfo(3))
    directCostsWithCoefficient = getValue(rowsInfo(9), columnsInfo(2))
    
    catalogsSum = 0
    For catalogsSumCounter% = 0 To UBound(cv)
        catalogsSum = catalogsSum + cv(catalogsSumCounter)
    Next catalogsSumCounter
     
    estimateSum = catalogsSum + equipment + materials + basicWage + machinesAndMechanisms + overheads + mortalProfit
    If estimateSum > totalCost And directCostsWithCoefficient <> 0 And basicWage > directCostsWithCoefficient Then
        machineOperatorsPaiment = basicWage - directCostsWithCoefficient
        basicWage = directCostsWithCoefficient
    End If
    
    If directCostsWithCoefficient > basicWage Then
        basicWage = directCostsWithCoefficient
    End If
    
    basicWage = basicWage - cv(UBound(cv))
    
    getAllEstimateValues = Array(totalCost, equipment, materials, basicWage, cv(0), cv(1), cv(2), cv(3), cv(4) + cv(5), cv(6) + cv(7), cv(8), cv(9), cv(10), cv(11), cv(12), cv(13), cv(14), cv(15), cv(16), cv(17), cv(18), cv(19), cv(20), cv(21), cv(22), cv(23), cv(24), machinesAndMechanisms, machineOperatorsPaiment, overheads, mortalProfit, totalTime, tableWidth)
End Function
Function getEstimateName() As String
    Dim estimateNumber As String
    Dim estimateName As String
    
    tableWidth = ActiveSheet.UsedRange.Column + ActiveSheet.UsedRange.Columns.Count - 1
    estimateNumber = estimateFindNext(Array("ЛОКАЛЬНЫЙ СМЕТНЫЙ РАСЧЕТ № ", "ЛОКАЛЬНАЯ СМЕТА № "), Cells).value
    
    Set nameDescription = Cells.find("(наименование работ")
    For i% = 2 To tableWidth
    Cells(nameDescription.Row - 1, i).Select
        If Not IsEmpty(ActiveCell.value) Then
            estimateName = ActiveCell.value
            getEstimateName = estimateNumber & ". " & estimateName
        End If
    Next i
    getEstimateName = estimateNumber & ". " & estimateName
End Function
Function getColumnsWithInformation(tableWidth As Long)
    Dim justification As range
    Dim totalTitle As range
    Dim totalTitleBegin As Long
    Dim totalTitleEnd As Long
    Dim total As range
    Dim salary As range
    Dim totalTime As range
    Set justification = estimateFindNext(Array("Шифр и номер позиции норматива", "Обосно"), Cells)
    Set totalTitle = estimateFindNext(Array("Общая стоимость"), Cells)
    totalTitle.Select
    totalTitleBegin = Selection.Cells(1).Column
    totalTitleEnd = Selection.Cells(Selection.Cells.Count).Column
    
    Set total = range(Cells(totalTitle.Row, totalTitleBegin), Cells(totalTitle.Row + 2, totalTitleEnd)).find("Всего")
    Set salary = estimateFindNext(Array("оплаты труда", "Осн.З/п"), ActiveSheet.range(Cells(totalTitle.Row, totalTitleBegin), Cells(totalTitle.Row + 2, totalTitleEnd)))
    Set totalTime = estimateFindPrevious(Array("Т/з осн.", "Всего"), range(Cells(totalTitle.Row, totalTitleEnd), Cells(totalTitle.Row + 2, tableWidth)))
    
    getColumnsWithInformation = Array(justification, total, salary, totalTime)
End Function
Function getRowsWithInformation(tableWidth As Long)
    Dim resultTitle As range
    Dim directCostsWithCoefficient As range
    Dim equipment As range
    Dim materials As range
    Dim basicWage As range
    Dim machinesAndMechanisms As range
    Dim machineOperatorsPaiment As range
    Dim overheads As range
    Dim mortalProfit As range
    Dim totalCost As range
    
    Set resultTitle = estimateFindPrevious(Array("ИТОГИ ПО СМЕТЕ:"), Cells)
    Set directCostsWithCoefficient = Cells.find("Итого прямые затраты по смете с учетом коэффициентов к итогам")
    Set totalCost = estimateFindPrevious(Array("ВСЕГО по смете"), Cells)
    Set equipment = estimateFindPrevious(Array("  Оборудование"), ActiveSheet.range(Cells(resultTitle.Row, resultTitle.Column), Cells(totalCost.Row, tableWidth)))
    Set materials = estimateFindPrevious(Array("  Материалы"), ActiveSheet.range(Cells(resultTitle.Row, resultTitle.Column), Cells(totalCost.Row, tableWidth)))
    Set basicWage = estimateFindPrevious(Array("  ФОТ", "  Основная заработная плата"), ActiveSheet.range(Cells(resultTitle.Row, resultTitle.Column), Cells(totalCost.Row, tableWidth)))
    Set machinesAndMechanisms = estimateFindPrevious(Array("  Машины и механизмы"), ActiveSheet.range(Cells(resultTitle.Row, resultTitle.Column), Cells(totalCost.Row, tableWidth)))
    Set machineOperatorsPaiment = estimateFindPrevious(Array("  в том числе заработная плата машинистов"), ActiveSheet.range(Cells(resultTitle.Row, resultTitle.Column), Cells(totalCost.Row, tableWidth)))
    Set overheads = estimateFindPrevious(Array("Накладные расходы"), ActiveSheet.range(Cells(resultTitle.Row, resultTitle.Column), Cells(totalCost.Row, tableWidth)))
    Set mortalProfit = estimateFindPrevious(Array("Сметная прибыль"), ActiveSheet.range(Cells(resultTitle.Row, resultTitle.Column), Cells(totalCost.Row, tableWidth)))
    
    getRowsWithInformation = Array(equipment, materials, basicWage, machinesAndMechanisms, machineOperatorsPaiment, overheads, mortalProfit, totalCost, resultTitle, directCostsWithCoefficient)
End Function
Function estimateFindNext(arr As Variant, findRange As range) As range
    For i% = 0 To UBound(arr)
      Set findCells = findRange.find(arr(i), searchDirection:=xlNext)
        If Not findCells Is Nothing Then
            Set estimateFindNext = findCells
        End If
    Next i
End Function
Function estimateFindPrevious(arr As Variant, findRange As range) As range
    For i% = 0 To UBound(arr)
      Set findCells = findRange.find(arr(i), searchDirection:=xlPrevious)
        If Not findCells Is Nothing Then
            Set estimateFindPrevious = findCells
        End If
    Next i
End Function
Function getValue(resultString, total) As Double
    If Not resultString Is Nothing Then
        getValue = range(Cells(resultString.Row, total.Column), Cells(resultString.Row, total.Column)).value / 1000
    End If
End Function
Function getTime(resultString, total)
    If Not resultString Is Nothing Then
        getTime = range(Cells(resultString.Row, total.Column), Cells(resultString.Row, total.Column)).value
    End If
End Function
Function getValuesFromOtherCatalogs(justification, total)
    Dim keys() As Variant
    Dim EstimatedReferenceValues(24) As Double
    Dim resultTitle As range
    Dim acc As Double
    Set resultTitle = Cells.find("ИТОГИ ПО СМЕТЕ:")
    keys = Array("БЦ1", "БЦ2", "БЦ3", "БЦ4", "БЦ5", "БЦ05", "БЦ6", "БЦ06", "БЦ7", "БЦ8", "БЦ9", "БЦ10", "БЦ11", "БЦ12", "БЦ13", "БЦ14", "БЦ15", "БЦ16", "БЦ17", "БЦ18", "БЦ19", "БЦ20", "БЦ21", "БЦ22", "260545")
    For i% = 0 To UBound(keys)
        acc = 0
        'If Not Cells.find(keys(i)) Is Nothing Then
            For j% = total.Row + 2 To resultTitle.Row
                If Not Cells(j, justification.Column).find(keys(i)) Is Nothing Then
                    acc = acc + Cells(j, total.Column).value
                End If
            Next j
        'End If
        EstimatedReferenceValues(i) = acc / 1000
    Next i
    
    getValuesFromOtherCatalogs = EstimatedReferenceValues
End Function