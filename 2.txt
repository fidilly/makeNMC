Sub makeNMC()
'
' makeNMC Макрос
'

'
    Dim sFolder As String, sFiles As String
    Dim i As Integer
    Dim currentFileName As String
    Dim startRow, startColumn As Integer
    Dim totalObjectCostRange As range
    Dim totalObjectCostColumn As Integer
    Dim laborCostsRange As range
    Dim laborCostsColumn As Integer

    startRow = ActiveCell.Row
    startColumn = ActiveCell.Column
    currentFileName = ActiveWorkbook.name
    i = 0
    
    With Application.FileDialog(msoFileDialogFolderPicker)
        If .Show = False Then Exit Sub
        sFolder = .SelectedItems(1)
    End With
    
    
    sFolder = sFolder & IIf(Right(sFolder, 1) = Application.PathSeparator, "", Application.PathSeparator)

    Application.ScreenUpdating = False

    allNMCNames = Array("разница", "сумма по расчету", "п/п", "Наименование объекта", "Стоимость объекта всего, тыс. руб.", "Оборудование", "Материалы", "ФОТ", "БЦ1", "БЦ2", "БЦ3", "БЦ4", "БЦ5", "БЦ6", "БЦ7", "БЦ8", "БЦ9", "БЦ10", "БЦ11", "БЦ12", "БЦ13", "БЦ14", "БЦ15", "БЦ16", "БЦ17", "БЦ18", "БЦ19", "БЦ20", "БЦ21", "БЦ22", "260545", "ЭММ", "в т.ч. оплата механизаторов", "Накладные расходы", "Сметная прибыль", "Время")
    For j% = 0 To UBound(allNMCNames)
        Cells(startRow, j + startColumn).value = allNMCNames(j)
    Next j

    sFiles = Dir(sFolder & "*.xlsx*")
    Do While sFiles <> ""
        Workbooks.Open sFolder & sFiles
        i = i + 1
        Application.Run "PERSONAL.XLSB!CalculateEstimate"
        Windows(currentFileName).Activate
        Cells(startRow + i, startColumn + 3).Select
        ActiveSheet.Paste
        Application.CutCopyMode = False
        Cells(startRow + i, startColumn + 2).value = i
        Cells(startRow + i, startColumn + 1).FormulaR1C1 = "=SUM(RC[4]:RC[30],RC[32]:RC[33]) * -1"
        Cells(startRow + i, startColumn).FormulaR1C1 = "=SUM(RC[1],RC[4])"
        
        Windows(sFiles).Activate
        ActiveWorkbook.Close False
        sFiles = Dir
    Loop
    
    Cells(startRow + i + 1, startColumn).FormulaR1C1 = "=SUM(R[-" & i & "]C:R[-1]C)"
    Cells(startRow + i + 1, startColumn + 1).FormulaR1C1 = "=SUM(R[-" & i & "]C:R[-1]C)"
    For k% = 4 To UBound(allNMCNames)
        Cells(startRow + i + 1, startColumn + k).FormulaR1C1 = "=SUM(R[-" & i & "]C:R[-1]C)"
    Next k
    
    Application.ScreenUpdating = True
End Sub
